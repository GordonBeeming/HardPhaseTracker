name: Build, Test & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Build for testing
      run: |
        xcodebuild clean build-for-testing \
          -project HardPhaseTracker.xcodeproj \
          -scheme HardPhaseTracker \
          -destination 'generic/platform=iOS Simulator' \
          -quiet \
          -skipPackagePluginValidation \
          DEVELOPMENT_TEAM="" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
          
    - name: Run unit tests
      run: |
        xcodebuild test-without-building \
          -project HardPhaseTracker.xcodeproj \
          -scheme HardPhaseTracker \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -quiet
          
    - name: Run UI tests
      run: |
        xcodebuild test-without-building \
          -project HardPhaseTracker.xcodeproj \
          -scheme HardPhaseTracker \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -quiet
      continue-on-error: true
      
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult
        retention-days: 30

  deploy-beta:
    name: Deploy to Beta (TestFlight)
    needs: build-and-test
    runs-on: macos-latest
    environment: beta
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Import signing certificates
      env:
        CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
        CERTIFICATES_PASSWORD: ${{ secrets.CERTIFICATES_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        echo "$CERTIFICATES_P12" | base64 --decode > certificate.p12
        security import certificate.p12 -k $KEYCHAIN_PATH -P "$CERTIFICATES_PASSWORD" -T /usr/bin/codesign
        security list-keychain -d user -s $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        rm certificate.p12
        
    - name: Import provisioning profile
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        echo "$PROVISIONING_PROFILE" | base64 --decode > $PP_PATH
        
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
        
    - name: Set build number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" HardPhaseTracker/Resources/Info.plist
        
        VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" HardPhaseTracker/Resources/Info.plist)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        echo "Version: $VERSION"
        echo "Build: $BUILD_NUMBER"
        echo "Commit: $COMMIT_HASH"
        echo "Environment: Beta (TestFlight)"
        
    - name: Archive app
      run: |
        xcodebuild archive \
          -project HardPhaseTracker.xcodeproj \
          -scheme HardPhaseTracker \
          -archivePath $RUNNER_TEMP/HardPhaseTracker.xcarchive \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}"
          
    - name: Export IPA
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist <<'EXPORT_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>${{ secrets.APPLE_TEAM_ID }}</string>
          <key>uploadSymbols</key>
          <true/>
          <key>uploadBitcode</key>
          <false/>
        </dict>
        </plist>
        EXPORT_EOF
        
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/HardPhaseTracker.xcarchive \
          -exportPath $RUNNER_TEMP/export \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist
          
    - name: Upload to TestFlight
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$APP_STORE_CONNECT_API_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
        
        xcrun altool --upload-app \
          --type ios \
          --file $RUNNER_TEMP/export/HardPhaseTracker.ipa \
          --apiKey $APP_STORE_CONNECT_API_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID
          
        echo "✅ Build uploaded to TestFlight"
        
    - name: Clean up
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -rf ~/.appstoreconnect/private_keys || true
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: HardPhaseTracker-beta-${{ github.run_number }}.ipa
        path: $RUNNER_TEMP/export/HardPhaseTracker.ipa
        retention-days: 90

  deploy-production:
    name: Deploy to Production (App Store)
    needs: deploy-beta
    runs-on: macos-latest
    environment: prod
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Import signing certificates
      env:
        CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
        CERTIFICATES_PASSWORD: ${{ secrets.CERTIFICATES_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        echo "$CERTIFICATES_P12" | base64 --decode > certificate.p12
        security import certificate.p12 -k $KEYCHAIN_PATH -P "$CERTIFICATES_PASSWORD" -T /usr/bin/codesign
        security list-keychain -d user -s $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        rm certificate.p12
        
    - name: Import provisioning profile
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        echo "$PROVISIONING_PROFILE" | base64 --decode > $PP_PATH
        
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
        
    - name: Set build number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" HardPhaseTracker/Resources/Info.plist
        
        VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" HardPhaseTracker/Resources/Info.plist)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        echo "Version: $VERSION"
        echo "Build: $BUILD_NUMBER"
        echo "Commit: $COMMIT_HASH"
        echo "Environment: Production (App Store)"
        
    - name: Archive app
      run: |
        xcodebuild archive \
          -project HardPhaseTracker.xcodeproj \
          -scheme HardPhaseTracker \
          -archivePath $RUNNER_TEMP/HardPhaseTracker.xcarchive \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}"
          
    - name: Export IPA
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist <<'EXPORT_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>${{ secrets.APPLE_TEAM_ID }}</string>
          <key>uploadSymbols</key>
          <true/>
          <key>uploadBitcode</key>
          <false/>
        </dict>
        </plist>
        EXPORT_EOF
        
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/HardPhaseTracker.xcarchive \
          -exportPath $RUNNER_TEMP/export \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist
          
    - name: Upload to App Store Connect
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$APP_STORE_CONNECT_API_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
        
        xcrun altool --upload-app \
          --type ios \
          --file $RUNNER_TEMP/export/HardPhaseTracker.ipa \
          --apiKey $APP_STORE_CONNECT_API_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID
          
        echo "✅ Build uploaded to App Store Connect"
        echo "⚠️  Complete submission in App Store Connect"
        
    - name: Clean up
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -rf ~/.appstoreconnect/private_keys || true
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: HardPhaseTracker-production-${{ github.run_number }}.ipa
        path: $RUNNER_TEMP/export/HardPhaseTracker.ipa
        retention-days: 90
